# Feature 4.5: Confidence Scoring

## Metadata
| Field | Value |
|-------|-------|
| **Feature ID** | 4.5 |
| **Phase** | 4 - Multi-Agent |
| **Priority** | High |
| **Estimated Effort** | 4-5 hours |
| **Dependencies** | 4.1 (Agent Framework) |
| **Approval** | [ ] |
| **Status** | Not Started |

---

## Overview

Implement confidence scoring for agent outputs, requiring 8.5+ confidence before presenting recommendations, with automatic iteration on low-confidence results.

## Requirements

### Functional
1. Score every agent output 1-10
2. Iterate until 8.5+ or max attempts
3. Flag low-confidence responses
4. Track confidence history
5. Explain confidence factors

### Non-Functional
- No output below threshold
- Transparent scoring
- Configurable threshold

---

## Technical Specification

```typescript
// src/core/agents/confidence-scorer.ts
export interface ConfidenceScore {
  score: number;          // 1-10
  factors: Factor[];
  iterations: number;
  meetsThreshold: boolean;
}

export class ConfidenceScorer {
  private threshold: number = 8.5;

  async scoreOutput(
    output: string,
    context: ScoringContext
  ): Promise<ConfidenceScore> {
    const factors = await this.evaluateFactors(output, context);
    const score = this.computeScore(factors);

    return {
      score,
      factors,
      iterations: context.iteration,
      meetsThreshold: score >= this.threshold,
    };
  }

  private async evaluateFactors(output: string, context: ScoringContext): Promise<Factor[]> {
    return [
      { name: 'Specificity', score: await this.scoreSpecificity(output) },
      { name: 'Actionability', score: await this.scoreActionability(output) },
      { name: 'Context Alignment', score: await this.scoreAlignment(output, context) },
      { name: 'Source Quality', score: await this.scoreSourceQuality(output) },
    ];
  }
}

// Integration with BaseAgent
export abstract class BaseAgent {
  async executeWithConfidence(input: string): Promise<ConfidentResult> {
    let result: AgentResult;
    let confidence: ConfidenceScore;
    let iteration = 0;

    do {
      result = await this.execute(input, { iteration });
      confidence = await this.scorer.scoreOutput(result.output, { iteration });
      iteration++;

      if (!confidence.meetsThreshold && iteration < this.maxIterations) {
        // Re-prompt with confidence feedback
        input = this.buildIterationPrompt(input, confidence);
      }
    } while (!confidence.meetsThreshold && iteration < this.maxIterations);

    return { result, confidence };
  }
}
```

---

## Tasks

| Task | Estimate |
|------|----------|
| Create ConfidenceScorer | 45 min |
| Define scoring factors | 30 min |
| Implement factor evaluation | 60 min |
| Add iteration loop | 30 min |
| Integrate with agents | 30 min |
| Add confidence display | 20 min |
| Write tests | 45 min |

---

## Acceptance Criteria
- [ ] Outputs scored 1-10
- [ ] Iteration on low scores
- [ ] 8.5+ threshold enforced
- [ ] Factors explained
- [ ] History tracked

