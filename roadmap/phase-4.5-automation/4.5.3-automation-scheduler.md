# Feature 4.5.3: Automation Scheduler

## Metadata
| Field | Value |
|-------|-------|
| **Feature ID** | 4.5.3 |
| **Phase** | 4.5 - Automation & Workflows |
| **Priority** | High |
| **Estimated Effort** | 6-8 hours |
| **Dependencies** | 4.2 (Mentor Agent), 2.4 (Business Entity) |
| **Approval** | [ ] |
| **Status** | Not Started |

---

## Overview

Cron-based automation system that schedules recurring tasks, check-ins, and metric reviews based on business state and user preferences.

## Requirements

### Functional
1. Cron job scheduling
2. Recurring task definitions
3. Background job queue
4. Notification system
5. User preferences (frequency, time)
6. Job history & audit

### Non-Functional
- Reliable execution (no missed jobs)
- Timezone-aware
- Graceful failure handling
- Scalable (100+ jobs)

---

## Automation Library

### Daily Automations

**Morning Brief (8 AM)**
```yaml
automation:
  id: daily_morning_brief
  name: "Daily Morning Brief"
  schedule: "0 8 * * *"  # 8 AM daily
  enabled_by_default: true

  tasks:
    - Check yesterday's progress
    - Review open tasks
    - Suggest today's priority
    - Surface relevant memories

  output: |
    Good morning! Here's your brief:

    âœ… Yesterday: [Completed tasks]
    ðŸ“‹ Today: [Suggested priorities]
    ðŸ’¡ Insight: [AI-generated insight from context]
```

**End-of-Day Reflection (6 PM)**
```yaml
automation:
  id: daily_eod_reflection
  schedule: "0 18 * * *"  # 6 PM daily

  tasks:
    - Prompt: "What did you accomplish today?"
    - Extract: Wins, blockers, learnings
    - Update: Business context
    - Celebrate: Progress made
```

---

### Weekly Automations

**Monday: Week Planning (9 AM)**
```yaml
automation:
  id: weekly_planning
  schedule: "0 9 * * 1"  # Monday 9 AM

  tasks:
    - Review last week's goals
    - Agent: Analyze progress vs. plan
    - Suggest: This week's priorities
    - Create: Weekly goals checklist
```

**Friday: Week Review (5 PM)**
```yaml
automation:
  id: weekly_review
  schedule: "0 17 * * 5"  # Friday 5 PM

  tasks:
    - Prompt: "What went well this week?"
    - Prompt: "What didn't go as planned?"
    - Prompt: "Key learnings?"
    - Agent: Synthesize insights
    - Archive: Week summary
```

**Sunday: Metrics Check (10 AM)**
```yaml
automation:
  id: weekly_metrics
  schedule: "0 10 * * 0"  # Sunday 10 AM

  tasks:
    - Prompt: "Update key metrics (revenue, users, etc.)"
    - Analyze: Week-over-week changes
    - Agent: Interpret trends
    - Alert: If metrics declining
```

---

### Monthly Automations

**Month Start: Goal Setting (1st, 9 AM)**
```yaml
automation:
  id: monthly_goal_setting
  schedule: "0 9 1 * *"  # 1st of month, 9 AM

  tasks:
    - Review last month's goals
    - Calculate: Goal completion rate
    - Agent: Recommend this month's focus
    - Create: Monthly OKRs
```

**Month End: Review (Last day, 6 PM)**
```yaml
automation:
  id: monthly_review
  schedule: "0 18 L * *"  # Last day of month, 6 PM

  tasks:
    - Summarize: Month's progress
    - Celebrate: Wins
    - Analyze: Patterns and trends
    - Agent: Strategic recommendations
```

**Investor Update Reminder (15th)**
```yaml
automation:
  id: investor_update_reminder
  schedule: "0 9 15 * *"  # 15th of month
  condition:
    stage: [mvp, growth, scale]
    has_investors: true

  tasks:
    - Prompt: "Draft monthly investor update"
    - Template: Metrics, wins, asks
    - Agent: Help polish update
```

---

### Stage-Specific Automations

**IDEA Stage: Customer Interview Reminder**
```yaml
automation:
  id: interview_reminder
  schedule: "0 10 * * 2,4"  # Tuesday, Thursday 10 AM
  condition:
    stage: idea
    interviews_this_week: < 2

  tasks:
    - Reminder: "Schedule customer interviews"
    - Suggest: Interview questions
    - Track: Interview count
```

**MVP Stage: Build Progress Check**
```yaml
automation:
  id: build_progress_check
  schedule: "0 15 * * *"  # Daily 3 PM
  condition:
    stage: mvp
    mvp_launched: false

  tasks:
    - Prompt: "Update build progress"
    - Track: Days since started
    - Alert: If no progress in 3 days
    - Agent: Unblock issues
```

**GROWTH Stage: Channel Performance Review**
```yaml
automation:
  id: channel_performance
  schedule: "0 9 * * 1"  # Monday 9 AM
  condition:
    stage: growth

  tasks:
    - Prompt: "Update channel metrics (CAC, conversion)"
    - Analyze: Best performing channel
    - Agent: Recommend optimizations
```

---

## Technical Implementation

```typescript
// src/core/automation/scheduler.ts
import * as cron from 'node-cron';
import { Queue, Worker } from 'bullmq';

export interface AutomationDefinition {
  id: string;
  name: string;
  schedule: string;  // Cron expression
  tasks: AutomationTask[];
  condition?: AutomationCondition;
  enabled: boolean;
}

export class AutomationScheduler {
  private jobs: Map<string, cron.ScheduledTask> = new Map();
  private queue: Queue;
  private worker: Worker;

  constructor(
    private automationRepo: AutomationRepository,
    private businessService: BusinessService,
    private mentorAgent: MentorAgent
  ) {
    this.queue = new Queue('automations', {
      connection: { host: 'localhost', port: 6379 },
    });

    this.worker = new Worker('automations', async (job) => {
      await this.executeAutomation(job.data.automationId, job.data.businessId);
    });
  }

  async start(): Promise<void> {
    const automations = await this.automationRepo.findAll();

    for (const automation of automations) {
      this.scheduleAutomation(automation);
    }
  }

  private scheduleAutomation(automation: AutomationDefinition): void {
    const task = cron.schedule(automation.schedule, async () => {
      // Check if automation should run for each business
      const businesses = await this.businessService.getAllActive();

      for (const business of businesses) {
        if (await this.shouldRun(automation, business)) {
          await this.queue.add(automation.id, {
            automationId: automation.id,
            businessId: business.id,
          });
        }
      }
    });

    this.jobs.set(automation.id, task);
  }

  private async shouldRun(
    automation: AutomationDefinition,
    business: Business
  ): Promise<boolean> {
    if (!automation.enabled) return false;
    if (!automation.condition) return true;

    // Check stage condition
    if (automation.condition.stage) {
      if (!automation.condition.stage.includes(business.stage)) {
        return false;
      }
    }

    // Check other conditions
    // ... custom logic

    return true;
  }

  private async executeAutomation(
    automationId: string,
    businessId: string
  ): Promise<void> {
    const automation = await this.automationRepo.findById(automationId);
    const business = await this.businessService.getById(businessId);

    for (const task of automation.tasks) {
      switch (task.type) {
        case 'prompt':
          await this.sendPrompt(businessId, task.message);
          break;

        case 'agent':
          await this.runAgent(businessId, task.agentId, task.prompt);
          break;

        case 'check':
          await this.performCheck(businessId, task.condition);
          break;

        case 'alert':
          await this.sendAlert(businessId, task.message);
          break;
      }
    }

    // Log execution
    await this.automationRepo.logExecution(automationId, businessId, {
      status: 'completed',
      timestamp: new Date(),
    });
  }

  async stop(): Promise<void> {
    this.jobs.forEach(job => job.stop());
    await this.queue.close();
    await this.worker.close();
  }
}
```

---

## Tasks

| Task | Estimate |
|------|----------|
| Add node-cron + BullMQ | 30 min |
| Create AutomationScheduler | 90 min |
| Define automation library (YAML) | 90 min |
| Implement job execution | 60 min |
| Add notification system | 45 min |
| Create user preferences | 45 min |
| Add job history tracking | 30 min |
| Write tests | 45 min |

---

## Acceptance Criteria
- [ ] Cron jobs run on schedule
- [ ] Stage-specific automations work
- [ ] Condition checking works
- [ ] Notifications delivered
- [ ] User can configure preferences
- [ ] Job history tracked
- [ ] Missed jobs retried

