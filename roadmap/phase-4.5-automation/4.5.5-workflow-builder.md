# Feature 4.5.5: Workflow Builder (UI)

## Metadata
| Field | Value |
|-------|-------|
| **Feature ID** | 4.5.5 |
| **Phase** | 4.5 - Automation & Workflows |
| **Priority** | Medium |
| **Estimated Effort** | 8-10 hours |
| **Dependencies** | 4.5.1 (Workflow Engine), 5.1 (Desktop Shell) |
| **Approval** | [ ] |
| **Status** | Not Started |

---

## Overview

Visual workflow builder that allows users to create custom workflows without writing YAML, using drag-and-drop nodes and connections.

## Requirements

### Functional
1. Visual workflow canvas
2. Drag-and-drop step nodes
3. Connection between steps
4. Step configuration panel
5. Workflow validation
6. Save and test workflows

### Non-Functional
- Intuitive UX (non-technical users)
- Real-time validation
- Template library

---

## UI Components

### Workflow Canvas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ“‹ Customer Validation Workflow            [Save]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Toolbox                Canvas                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Task â”‚         â”‚   Start          â”‚            â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”¤         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚  â”‚Agent â”‚                  â”‚                       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”¤         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚Check â”‚         â”‚  Define Problem  â”‚            â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”¤         â”‚  (Task)          â”‚            â”‚
â”‚  â”‚Wait  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”¤                  â”‚                       â”‚
â”‚  â”‚Branchâ”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜         â”‚ Mentor Agent     â”‚            â”‚
â”‚                   â”‚ (Agent)          â”‚            â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                            â”‚                       â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚                   â”‚  Validated?      â”‚            â”‚
â”‚                   â”‚  (Decision)      â”‚            â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                      Yes â”‚   â”‚ No                 â”‚
â”‚                          â”‚   â””â”€â”€â†’ [Pivot]         â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚                   â”‚    Complete    â”‚              â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Node Types

**Task Node**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ“ Task         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Title: [input]  â”‚
â”‚ Description:    â”‚
â”‚ [textarea]      â”‚
â”‚                 â”‚
â”‚ â˜ Required      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Agent Node**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ¤– Agent        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Agent: [select] â”‚
â”‚ â–¡ Mentor        â”‚
â”‚ â–¡ Research      â”‚
â”‚                 â”‚
â”‚ Prompt:         â”‚
â”‚ [textarea]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Decision Node**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš¡ Decision     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Question:       â”‚
â”‚ [input]         â”‚
â”‚                 â”‚
â”‚ Options:        â”‚
â”‚ â€¢ Yes â†’ [node]  â”‚
â”‚ â€¢ No â†’ [node]   â”‚
â”‚ + Add option    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Wait Node**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â° Wait         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Duration:       â”‚
â”‚ [3] [days â–¼]   â”‚
â”‚                 â”‚
â”‚ Or until:       â”‚
â”‚ [date picker]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Technical Implementation

```typescript
// components/WorkflowBuilder/index.tsx
import { ReactFlow, Node, Edge } from 'reactflow';

export const WorkflowBuilder: React.FC = () => {
  const [nodes, setNodes] = useState<Node[]>([]);
  const [edges, setEdges] = useState<Edge[]>([]);
  const [selectedNode, setSelectedNode] = useState<Node | null>(null);

  const nodeTypes = {
    task: TaskNode,
    agent: AgentNode,
    decision: DecisionNode,
    wait: WaitNode,
  };

  const onDrop = (event: DragEvent) => {
    const type = event.dataTransfer.getData('nodeType');
    const position = { x: event.clientX, y: event.clientY };

    const newNode: Node = {
      id: generateId(),
      type,
      position,
      data: getDefaultData(type),
    };

    setNodes([...nodes, newNode]);
  };

  const onSave = async () => {
    const workflow = convertToWorkflowDefinition(nodes, edges);
    await workflowService.save(workflow);
  };

  return (
    <div className="workflow-builder">
      <Toolbox onDragStart={(type) => setDraggedType(type)} />

      <ReactFlow
        nodes={nodes}
        edges={edges}
        nodeTypes={nodeTypes}
        onNodesChange={setNodes}
        onEdgesChange={setEdges}
        onNodeClick={(_, node) => setSelectedNode(node)}
        onDrop={onDrop}
      />

      {selectedNode && (
        <ConfigPanel
          node={selectedNode}
          onChange={(data) => updateNodeData(selectedNode.id, data)}
        />
      )}

      <Toolbar>
        <button onClick={onSave}>Save</button>
        <button onClick={onTest}>Test Run</button>
        <button onClick={onValidate}>Validate</button>
      </Toolbar>
    </div>
  );
};

// Convert visual workflow to YAML definition
function convertToWorkflowDefinition(
  nodes: Node[],
  edges: Edge[]
): WorkflowDefinition {
  return {
    id: generateId(),
    name: 'Custom Workflow',
    steps: nodes.map(node => ({
      id: node.id,
      type: node.type,
      ...node.data,
      next: getNextStep(node.id, edges),
    })),
  };
}
```

---

## Workflow Templates

```typescript
// Pre-built templates users can customize
export const WORKFLOW_TEMPLATES = [
  {
    id: 'simple_checklist',
    name: 'Simple Checklist',
    description: 'Basic task checklist',
    nodes: [
      { type: 'task', data: { title: 'Step 1' } },
      { type: 'task', data: { title: 'Step 2' } },
      { type: 'task', data: { title: 'Step 3' } },
    ],
  },
  {
    id: 'research_workflow',
    name: 'Research + Decision',
    description: 'Research a topic and make decision',
    nodes: [
      { type: 'agent', data: { agent: 'research', prompt: 'Research...' } },
      { type: 'decision', data: { question: 'Continue?' } },
    ],
  },
  // ... more templates
];
```

---

## Tasks

| Task | Estimate |
|------|----------|
| Set up ReactFlow | 45 min |
| Create node components | 90 min |
| Implement drag-and-drop | 60 min |
| Build config panel | 60 min |
| Add edge connections | 45 min |
| Implement save/load | 45 min |
| Add validation | 45 min |
| Create templates | 60 min |
| Add test runner | 45 min |
| Write tests | 30 min |

---

## Acceptance Criteria
- [ ] Drag-and-drop nodes work
- [ ] Nodes connect correctly
- [ ] Config panel updates nodes
- [ ] Save workflow to DB
- [ ] Load workflow from DB
- [ ] Validation catches errors
- [ ] Test run executes workflow
- [ ] Templates loadable

---

## Future Enhancements
- Conditional branching UI
- Loop nodes
- Parallel execution paths
- Workflow versioning
- Collaboration (share workflows)

