# Feature 2.3: Conversation Storage (CLI)

## Metadata
| Field | Value |
|-------|-------|
| **Feature ID** | CLI-2.3 |
| **Phase** | 2 - Local Storage (CLI) |
| **Priority** | Critical |
| **Estimated Effort** | 3-4 hours |
| **Dependencies** | CLI-2.1 (SQLite), CLI-2.2 (Local User) |
| **Approval** | [ ] |
| **Status** | Not Started |

---

## Overview

Migrate conversation storage from JSON files to SQLite for better query performance, integrity, and features like search.

## User Story

As a **CLI user**, I want **conversations stored in SQLite** so that **I can search and manage them efficiently**.

---

## Technical Specification

```typescript
// src/infrastructure/repositories/conversation.repository.ts
export class ConversationRepository {
  constructor(private db: SQLiteClient) {}

  async create(businessId: string): Promise<Conversation> {
    return this.db.queryOne<Conversation>(
      `INSERT INTO conversations (id, business_id)
       VALUES (?, ?)
       RETURNING *`,
      [generateId(), businessId]
    )!;
  }

  async findByBusinessId(businessId: string): Promise<Conversation[]> {
    return this.db.query<Conversation>(
      `SELECT * FROM conversations
       WHERE business_id = ?
       ORDER BY updated_at DESC`,
      [businessId]
    );
  }

  async updateTitle(id: string, title: string): Promise<void> {
    this.db.execute(
      `UPDATE conversations SET title = ?, updated_at = unixepoch() WHERE id = ?`,
      [title, id]
    );
  }
}

// src/infrastructure/repositories/message.repository.ts
export class MessageRepository {
  constructor(private db: SQLiteClient) {}

  async create(data: {
    conversationId: string;
    role: string;
    content: string;
  }): Promise<Message> {
    return this.db.queryOne<Message>(
      `INSERT INTO messages (id, conversation_id, role, content)
       VALUES (?, ?, ?, ?)
       RETURNING *`,
      [generateId(), data.conversationId, data.role, data.content]
    )!;
  }

  async findByConversationId(conversationId: string): Promise<Message[]> {
    return this.db.query<Message>(
      `SELECT * FROM messages
       WHERE conversation_id = ?
       ORDER BY created_at ASC`,
      [conversationId]
    );
  }

  async search(query: string): Promise<Message[]> {
    return this.db.query<Message>(
      `SELECT m.*, c.title as conversation_title
       FROM messages m
       JOIN conversations c ON m.conversation_id = c.id
       WHERE m.content LIKE ?
       ORDER BY m.created_at DESC
       LIMIT 50`,
      [`%${query}%`]
    );
  }
}
```

---

## Tasks

| Task | Estimate |
|------|----------|
| Create ConversationRepository | 30 min |
| Create MessageRepository | 30 min |
| Migrate from JSON storage | 45 min |
| Add search functionality | 30 min |
| Update chat service | 30 min |
| Write tests | 30 min |

---

## Acceptance Criteria
- [ ] Conversations stored in SQLite
- [ ] Messages linked to conversations
- [ ] Can search message history
- [ ] Auto-title generation works
- [ ] Migration from JSON succeeds
