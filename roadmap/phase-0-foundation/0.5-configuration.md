# Feature 0.5: Configuration System

## Metadata
| Field | Value |
|-------|-------|
| **Feature ID** | 0.5 |
| **Phase** | 0 - Foundation |
| **Priority** | High |
| **Estimated Effort** | 3-4 hours |
| **Dependencies** | 0.1 (Project Setup), 0.3 (Core Architecture) |
| **Approval** | [ ] |
| **Status** | Not Started |

---

## Overview

Implement a robust configuration system that handles environment variables, config files, and runtime settings with validation and type safety.

## User Story

As a **developer**, I want a **centralized configuration system** so that **settings are validated, typed, and easy to manage across environments**.

---

## Requirements

### Functional Requirements
1. Load from .env file
2. Load from environment variables
3. Support config file (~/.bos/config.json)
4. Validate all config values
5. Provide typed access to config
6. Support multiple LLM providers
7. Default values for optional settings

### Non-Functional Requirements
- Fail fast on invalid config
- Clear error messages for missing values
- No secrets logged

---

## Technical Specification

### Config Schema

```typescript
// src/config/schema.ts
import { z } from 'zod';

export const configSchema = z.object({
  // Environment
  nodeEnv: z.enum(['development', 'production', 'test']).default('development'),
  logLevel: z.enum(['debug', 'info', 'warn', 'error']).default('info'),

  // LLM Provider
  llm: z.object({
    provider: z.enum(['openai', 'kimi', 'anthropic']).default('openai'),
    apiKey: z.string().min(1, 'API key required'),
    model: z.string().default('gpt-4'),
    baseUrl: z.string().url().optional(),
    maxTokens: z.number().int().positive().default(4096),
    temperature: z.number().min(0).max(2).default(0.7),
  }),

  // Storage
  storage: z.object({
    type: z.enum(['json', 'postgres']).default('json'),
    path: z.string().default('~/.bos/data'),
    // Postgres (optional)
    postgresUrl: z.string().url().optional(),
  }),

  // Features
  features: z.object({
    streaming: z.boolean().default(true),
    memory: z.boolean().default(true),
    debug: z.boolean().default(false),
  }),
});

export type Config = z.infer<typeof configSchema>;
```

### Config Loader

```typescript
// src/config/loader.ts
import { configSchema, Config } from './schema';
import { ConfigError } from '../core/errors';
import * as fs from 'fs';
import * as path from 'path';
import * as dotenv from 'dotenv';

export function loadConfig(): Config {
  // 1. Load .env file
  dotenv.config();

  // 2. Load config file if exists
  const configFile = loadConfigFile();

  // 3. Build config object from env + file
  const rawConfig = {
    nodeEnv: process.env.NODE_ENV,
    logLevel: process.env.LOG_LEVEL,
    llm: {
      provider: process.env.LLM_PROVIDER || configFile?.llm?.provider,
      apiKey: process.env.OPENAI_API_KEY ||
              process.env.KIMI_API_KEY ||
              configFile?.llm?.apiKey,
      model: process.env.LLM_MODEL || configFile?.llm?.model,
      baseUrl: process.env.LLM_BASE_URL || configFile?.llm?.baseUrl,
      maxTokens: parseInt(process.env.LLM_MAX_TOKENS || '4096'),
      temperature: parseFloat(process.env.LLM_TEMPERATURE || '0.7'),
    },
    storage: {
      type: process.env.STORAGE_TYPE || configFile?.storage?.type,
      path: process.env.STORAGE_PATH || configFile?.storage?.path,
      postgresUrl: process.env.DATABASE_URL || configFile?.storage?.postgresUrl,
    },
    features: {
      streaming: process.env.FEATURE_STREAMING !== 'false',
      memory: process.env.FEATURE_MEMORY !== 'false',
      debug: process.env.DEBUG === 'true',
    },
  };

  // 4. Validate
  const result = configSchema.safeParse(rawConfig);

  if (!result.success) {
    const errors = result.error.issues
      .map(i => `  - ${i.path.join('.')}: ${i.message}`)
      .join('\n');
    throw new ConfigError(`Invalid configuration:\n${errors}`);
  }

  return result.data;
}

function loadConfigFile(): Partial<Config> | null {
  const configPath = path.join(
    process.env.HOME || '~',
    '.bos',
    'config.json'
  );

  if (fs.existsSync(configPath)) {
    return JSON.parse(fs.readFileSync(configPath, 'utf-8'));
  }
  return null;
}
```

### Config Access

```typescript
// src/config/index.ts
import { Config } from './schema';
import { loadConfig } from './loader';

let config: Config | null = null;

export function getConfig(): Config {
  if (!config) {
    config = loadConfig();
  }
  return config;
}

// For testing - allow reset
export function resetConfig(): void {
  config = null;
}

// Type-safe accessors
export const getLLMConfig = () => getConfig().llm;
export const getStorageConfig = () => getConfig().storage;
export const isDebug = () => getConfig().features.debug;
```

### Provider-Specific Config

```typescript
// src/config/providers.ts

export const LLM_PROVIDERS = {
  openai: {
    baseUrl: 'https://api.openai.com/v1',
    models: ['gpt-4', 'gpt-4-turbo', 'gpt-3.5-turbo'],
    envKey: 'OPENAI_API_KEY',
  },
  kimi: {
    baseUrl: 'https://api.moonshot.ai/v1',
    models: ['kimi-k2.5', 'moonshot-v1-8k'],
    envKey: 'KIMI_API_KEY',
  },
  anthropic: {
    baseUrl: 'https://api.anthropic.com/v1',
    models: ['claude-3-opus', 'claude-3-sonnet'],
    envKey: 'ANTHROPIC_API_KEY',
  },
} as const;
```

---

## Tasks Breakdown

| Task | Description | Estimate |
|------|-------------|----------|
| 0.5.1 | Define Zod config schema | 30 min |
| 0.5.2 | Implement dotenv loading | 15 min |
| 0.5.3 | Implement config file loading | 30 min |
| 0.5.4 | Merge env + file config | 30 min |
| 0.5.5 | Add validation with clear errors | 30 min |
| 0.5.6 | Create typed accessors | 20 min |
| 0.5.7 | Add provider configurations | 20 min |
| 0.5.8 | Create .env.example | 15 min |
| 0.5.9 | Write unit tests | 45 min |
| 0.5.10 | Document config options | 20 min |

---

## Acceptance Criteria

- [ ] Loads from .env file
- [ ] Loads from ~/.bos/config.json
- [ ] Environment variables override file
- [ ] Validates all config values
- [ ] Clear error on missing API key
- [ ] Typed config access throughout app
- [ ] Supports OpenAI, Kimi, Anthropic
- [ ] Default values applied correctly
- [ ] 90%+ test coverage

---

## Environment Variables

```env
# .env.example

# Environment
NODE_ENV=development
LOG_LEVEL=debug

# LLM Provider (choose one)
LLM_PROVIDER=openai   # openai | kimi | anthropic

# OpenAI
OPENAI_API_KEY=sk-...
LLM_MODEL=gpt-4

# Kimi (alternative)
# KIMI_API_KEY=...
# LLM_BASE_URL=https://api.moonshot.ai/v1
# LLM_MODEL=kimi-k2.5

# Storage
STORAGE_TYPE=json
STORAGE_PATH=~/.bos/data

# Features
FEATURE_STREAMING=true
FEATURE_MEMORY=true
DEBUG=false
```

---

## File Structure

```
src/
├── config/
│   ├── index.ts        # Main exports
│   ├── schema.ts       # Zod schema
│   ├── loader.ts       # Loading logic
│   └── providers.ts    # LLM provider configs
```

---

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Secrets in logs | High | Never log config.llm.apiKey |
| Missing required config | Medium | Fail fast with clear message |

---

## Definition of Done

- [ ] All tasks completed
- [ ] All acceptance criteria met
- [ ] Tests passing
- [ ] .env.example documented
- [ ] No secrets logged

