# Feature 0.3: Core Architecture

## Metadata
| Field | Value |
|-------|-------|
| **Feature ID** | 0.3 |
| **Phase** | 0 - Foundation |
| **Priority** | Critical |
| **Estimated Effort** | 6-8 hours |
| **Dependencies** | 0.1 (Project Setup) |
| **Approval** | [ ] |
| **Status** | Not Started |

---

## Overview

Establish the core architectural patterns including dependency injection, service layer abstractions, error handling patterns, and type definitions that all features will build upon.

## User Story

As a **developer**, I want a **clean, modular architecture** so that **features can be developed independently and tested easily**.

---

## Requirements

### Functional Requirements
1. Define core interfaces for all services
2. Implement dependency injection container
3. Create base error classes
4. Define shared types and enums
5. Establish logging abstraction
6. Create result/error pattern for operations

### Non-Functional Requirements
- Loose coupling between modules
- Easy to mock for testing
- Type-safe throughout
- Consistent error handling

---

## Technical Specification

### Architecture Pattern: Clean Architecture

```
┌─────────────────────────────────────────┐
│              CLI / API                   │ ← Presentation
├─────────────────────────────────────────┤
│            Use Cases                     │ ← Application
├─────────────────────────────────────────┤
│         Domain Services                  │ ← Domain
├─────────────────────────────────────────┤
│    Repositories / External APIs          │ ← Infrastructure
└─────────────────────────────────────────┘
```

### Core Interfaces

```typescript
// src/types/index.ts

// Result pattern for operations
export type Result<T, E = Error> =
  | { success: true; data: T }
  | { success: false; error: E };

// Base entity
export interface Entity {
  id: string;
  createdAt: Date;
  updatedAt: Date;
}

// Business context
export interface BusinessContext {
  businessId: string;
  businessName: string;
  stage: BusinessStage;
  userId: string;
}

export enum BusinessStage {
  IDEA = 'idea',
  MVP = 'mvp',
  GROWTH = 'growth',
  SCALE = 'scale'
}

// Message types
export interface Message {
  id: string;
  role: 'user' | 'assistant' | 'system';
  content: string;
  timestamp: Date;
  metadata?: Record<string, unknown>;
}

// Conversation
export interface Conversation {
  id: string;
  businessId: string;
  messages: Message[];
  createdAt: Date;
  updatedAt: Date;
}
```

### Service Interfaces

```typescript
// src/core/interfaces/llm.interface.ts
export interface ILLMService {
  chat(messages: Message[], options?: ChatOptions): Promise<Result<Message>>;
  stream(messages: Message[], options?: ChatOptions): AsyncIterable<string>;
}

// src/core/interfaces/memory.interface.ts
export interface IMemoryService {
  save(conversation: Conversation): Promise<Result<void>>;
  load(conversationId: string): Promise<Result<Conversation>>;
  search(query: string, limit?: number): Promise<Result<Message[]>>;
}

// src/core/interfaces/context.interface.ts
export interface IContextService {
  extract(messages: Message[]): Promise<Result<BusinessContext>>;
  enrich(context: BusinessContext): Promise<Result<BusinessContext>>;
}
```

### Error Classes

```typescript
// src/core/errors/index.ts

export class AppError extends Error {
  constructor(
    message: string,
    public code: string,
    public statusCode: number = 500,
    public isOperational: boolean = true
  ) {
    super(message);
    this.name = this.constructor.name;
    Error.captureStackTrace(this, this.constructor);
  }
}

export class ValidationError extends AppError {
  constructor(message: string) {
    super(message, 'VALIDATION_ERROR', 400);
  }
}

export class NotFoundError extends AppError {
  constructor(resource: string) {
    super(`${resource} not found`, 'NOT_FOUND', 404);
  }
}

export class LLMError extends AppError {
  constructor(message: string) {
    super(message, 'LLM_ERROR', 502);
  }
}

export class ConfigError extends AppError {
  constructor(message: string) {
    super(message, 'CONFIG_ERROR', 500, false);
  }
}
```

### Dependency Injection

```typescript
// src/infrastructure/container.ts
import { Container } from './di';

export const container = new Container();

// Registration
container.register('llmService', () => new OpenAIService(config));
container.register('memoryService', () => new JSONMemoryService());
container.register('contextService', () => new ContextService());

// Resolution
const llm = container.resolve<ILLMService>('llmService');
```

### Logger Interface

```typescript
// src/infrastructure/logger/index.ts
export interface ILogger {
  debug(message: string, meta?: object): void;
  info(message: string, meta?: object): void;
  warn(message: string, meta?: object): void;
  error(message: string, error?: Error, meta?: object): void;
}

export class ConsoleLogger implements ILogger {
  constructor(private context: string) {}

  debug(message: string, meta?: object) {
    if (process.env.LOG_LEVEL === 'debug') {
      console.debug(`[${this.context}] ${message}`, meta);
    }
  }
  // ... other methods
}
```

---

## Tasks Breakdown

| Task | Description | Estimate |
|------|-------------|----------|
| 0.3.1 | Create core type definitions | 45 min |
| 0.3.2 | Implement Result pattern utilities | 30 min |
| 0.3.3 | Create error class hierarchy | 30 min |
| 0.3.4 | Define service interfaces | 45 min |
| 0.3.5 | Implement simple DI container | 60 min |
| 0.3.6 | Create logger abstraction | 30 min |
| 0.3.7 | Add Zod schemas for validation | 45 min |
| 0.3.8 | Write unit tests for utilities | 45 min |
| 0.3.9 | Document architecture in README | 30 min |

---

## Acceptance Criteria

- [ ] All core types exported from src/types
- [ ] Result pattern implemented with helpers
- [ ] Error classes extend AppError
- [ ] Service interfaces defined
- [ ] DI container working
- [ ] Logger abstraction working
- [ ] Zod schemas for Message, Conversation
- [ ] 80%+ test coverage on utilities
- [ ] Architecture documented

---

## File Structure

```
src/
├── types/
│   ├── index.ts           # All type exports
│   ├── entities.ts        # Entity types
│   ├── messages.ts        # Message types
│   └── business.ts        # Business types
├── core/
│   ├── interfaces/
│   │   ├── llm.interface.ts
│   │   ├── memory.interface.ts
│   │   └── context.interface.ts
│   ├── errors/
│   │   └── index.ts
│   └── utils/
│       ├── result.ts
│       └── validation.ts
└── infrastructure/
    ├── container.ts
    └── logger/
        └── index.ts
```

---

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Over-engineering | Medium | Start simple, refactor later |
| Type complexity | Low | Use type inference where possible |

---

## Definition of Done

- [ ] All tasks completed
- [ ] All acceptance criteria met
- [ ] Tests passing
- [ ] No type errors
- [ ] Architecture documented

