# Feature 7.1: Cloud Database (PostgreSQL + pgvector)

## Metadata
| Field | Value |
|-------|-------|
| **Feature ID** | WEB-7.1 |
| **Phase** | 7 - Cloud Infrastructure (Web) |
| **Priority** | Critical |
| **Estimated Effort** | 6-8 hours |
| **Dependencies** | CLI v1.0 complete |
| **Approval** | [ ] |
| **Status** | Not Started |

---

## Overview

Set up cloud PostgreSQL with pgvector for the web/mobile app, enabling multi-device sync, team collaboration, and managed infrastructure.

## User Story

As a **web user**, I want my **data in the cloud** so that **I can access it from any device and collaborate with my team**.

---

## Requirements

### Functional
1. PostgreSQL database (Supabase or Railway)
2. pgvector extension
3. Row-level security (RLS)
4. Real-time subscriptions
5. Connection pooling

### Non-Functional
- 99.9% uptime
- Automatic backups
- Scalable (10K+ users)
- GDPR compliant

---

## Technical Specification

### Infrastructure Options

**Option A: Supabase (Recommended)**
- ✅ PostgreSQL + pgvector included
- ✅ Real-time subscriptions
- ✅ Row-level security built-in
- ✅ Auth included
- ✅ Edge functions
- ✅ Generous free tier
- **Cost:** $25/mo (Pro), $599/mo (Team)

**Option B: Railway**
- ✅ Simple PostgreSQL
- ✅ Easy deploys
- ✅ Good DX
- ❌ No real-time
- ❌ No built-in auth
- **Cost:** $5/mo base + usage

### Schema (Same as CLI, Plus Multi-Tenant)

```sql
-- Add tenant/organization support
CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  plan TEXT DEFAULT 'starter',  -- starter, pro, founder
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE organization_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role TEXT DEFAULT 'member',  -- owner, admin, member
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(organization_id, user_id)
);

-- Update businesses to support orgs
ALTER TABLE businesses
ADD COLUMN organization_id UUID REFERENCES organizations(id);

-- Row-Level Security
ALTER TABLE businesses ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own businesses"
  ON businesses FOR SELECT
  USING (
    user_id = auth.uid()
    OR organization_id IN (
      SELECT organization_id FROM organization_members
      WHERE user_id = auth.uid()
    )
  );

CREATE POLICY "Users can update own businesses"
  ON businesses FOR UPDATE
  USING (user_id = auth.uid());
```

### Supabase Client

```typescript
// src/infrastructure/database/supabase-client.ts
import { createClient, SupabaseClient } from '@supabase/supabase-js';

export class SupabaseDatabaseClient {
  private client: SupabaseClient;

  constructor() {
    this.client = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    );
  }

  async query<T>(table: string, query: any): Promise<T[]> {
    const { data, error } = await this.client
      .from(table)
      .select(query.select)
      .match(query.match || {})
      .order(query.order || 'created_at', { ascending: false })
      .limit(query.limit || 100);

    if (error) throw error;
    return data as T[];
  }

  async insert<T>(table: string, data: Partial<T>): Promise<T> {
    const { data: result, error } = await this.client
      .from(table)
      .insert(data)
      .select()
      .single();

    if (error) throw error;
    return result as T;
  }

  async update<T>(table: string, id: string, data: Partial<T>): Promise<T> {
    const { data: result, error } = await this.client
      .from(table)
      .update(data)
      .eq('id', id)
      .select()
      .single();

    if (error) throw error;
    return result as T;
  }

  // Real-time subscription
  subscribeToTable(
    table: string,
    callback: (payload: any) => void
  ): () => void {
    const channel = this.client
      .channel(`${table}-changes`)
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table },
        callback
      )
      .subscribe();

    return () => {
      this.client.removeChannel(channel);
    };
  }
}
```

### Migration from CLI

```typescript
// tools/migrate-cli-to-cloud.ts
export async function migrateFromCLI(
  cliDbPath: string,
  userId: string
): Promise<void> {
  // 1. Read CLI SQLite database
  const cliDb = new SQLiteClient(cliDbPath);

  // 2. Export all data
  const businesses = cliDb.query('SELECT * FROM businesses');
  const conversations = cliDb.query('SELECT * FROM conversations');
  const messages = cliDb.query('SELECT * FROM messages');

  // 3. Insert into cloud
  const cloudDb = new SupabaseDatabaseClient();

  for (const business of businesses) {
    await cloudDb.insert('businesses', {
      ...business,
      user_id: userId,
    });
  }

  // ... migrate conversations and messages

  console.log('✅ Migration complete');
}
```

---

## Tasks

| Task | Estimate |
|------|----------|
| Set up Supabase project | 30 min |
| Configure database | 45 min |
| Enable pgvector extension | 20 min |
| Run migrations | 30 min |
| Set up RLS policies | 60 min |
| Create database client | 45 min |
| Add real-time subscriptions | 45 min |
| Create migration tool | 60 min |
| Write tests | 45 min |

---

## Acceptance Criteria
- [ ] PostgreSQL operational
- [ ] pgvector enabled
- [ ] RLS policies working
- [ ] Real-time sync working
- [ ] CLI migration tool works
- [ ] Backups automated
- [ ] Connection pooling configured

---

## Environment Variables

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJxxx...
SUPABASE_SERVICE_ROLE_KEY=eyJxxx...

# Database (direct connection)
DATABASE_URL=postgresql://postgres:password@db.xxx.supabase.co:5432/postgres
```

---

## Cost Estimation

**Supabase Pro ($25/mo):**
- 8GB database
- 100GB bandwidth
- 50GB storage
- 500K vector operations/mo

**Sufficient for:** 500 active users, 50K conversations

