# Feature 10.1: Stripe Payment Integration (Web)

## Metadata
| Field | Value |
|-------|-------|
| **Feature ID** | WEB-10.1 |
| **Phase** | 10 - Launch & Growth (Web) |
| **Priority** | Critical |
| **Estimated Effort** | 5-6 hours |
| **Dependencies** | WEB-8.1 (Next.js Setup), WEB-7.2 (Auth System) |
| **Approval** | [ ] |
| **Status** | Not Started |

---

## Overview

Stripe integration for subscription payments with free/pro tiers, checkout flow, billing portal, and webhook handling for subscription lifecycle management.

---

## Technical Specification

### Pricing Plans

```typescript
// lib/stripe/plans.ts
export const PLANS = {
  free: {
    id: 'free',
    name: 'Free',
    price: 0,
    interval: 'month',
    features: [
      '10 conversations/month',
      'Basic workflows',
      'Email support',
      'Community access'
    ],
    limits: {
      conversations: 10,
      workflows: ['customer_validation', 'problem_validation']
    }
  },
  pro: {
    id: 'pro',
    name: 'Pro',
    price: 29,
    interval: 'month',
    stripeProductId: 'prod_xxx',
    stripePriceId: 'price_xxx',
    features: [
      'Unlimited conversations',
      'All 15 workflows',
      'Daily briefs & weekly reviews',
      'Priority support',
      'Advanced analytics'
    ],
    limits: {
      conversations: Infinity,
      workflows: 'all'
    }
  }
};
```

### Stripe Client Setup

```typescript
// lib/stripe/client.ts
import Stripe from 'stripe';

export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2023-10-16'
});

// app/api/create-checkout-session/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { withAuth } from '@/lib/auth';
import { stripe } from '@/lib/stripe/client';
import { PLANS } from '@/lib/stripe/plans';

export const POST = withAuth(async (req, userId) => {
  const { plan } = await req.json();

  if (plan !== 'pro') {
    return NextResponse.json({ error: 'Invalid plan' }, { status: 400 });
  }

  const session = await stripe.checkout.sessions.create({
    customer_email: req.user.email,
    client_reference_id: userId,
    payment_method_types: ['card'],
    mode: 'subscription',
    line_items: [
      {
        price: PLANS.pro.stripePriceId,
        quantity: 1
      }
    ],
    success_url: `${process.env.NEXT_PUBLIC_URL}/dashboard?subscription=success`,
    cancel_url: `${process.env.NEXT_PUBLIC_URL}/pricing?subscription=cancelled`,
    metadata: {
      userId
    }
  });

  return NextResponse.json({ url: session.url });
});
```

### Webhook Handler

```typescript
// app/api/webhooks/stripe/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { stripe } from '@/lib/stripe/client';
import { headers } from 'next/headers';
import { supabase } from '@/lib/supabase';

export async function POST(req: NextRequest) {
  const body = await req.text();
  const signature = headers().get('stripe-signature')!;

  let event: Stripe.Event;

  try {
    event = stripe.webhooks.constructEvent(
      body,
      signature,
      process.env.STRIPE_WEBHOOK_SECRET!
    );
  } catch (err) {
    return NextResponse.json({ error: 'Invalid signature' }, { status: 400 });
  }

  switch (event.type) {
    case 'checkout.session.completed':
      await handleCheckoutCompleted(event.data.object);
      break;

    case 'customer.subscription.updated':
      await handleSubscriptionUpdated(event.data.object);
      break;

    case 'customer.subscription.deleted':
      await handleSubscriptionDeleted(event.data.object);
      break;

    case 'invoice.payment_failed':
      await handlePaymentFailed(event.data.object);
      break;
  }

  return NextResponse.json({ received: true });
}

async function handleCheckoutCompleted(session: Stripe.Checkout.Session) {
  const userId = session.metadata?.userId;

  if (!userId) return;

  await supabase
    .from('users')
    .update({
      subscription_status: 'active',
      stripe_customer_id: session.customer as string,
      stripe_subscription_id: session.subscription as string,
      plan: 'pro'
    })
    .eq('id', userId);
}

async function handleSubscriptionUpdated(subscription: Stripe.Subscription) {
  const customerId = subscription.customer as string;

  await supabase
    .from('users')
    .update({
      subscription_status: subscription.status,
      plan: subscription.status === 'active' ? 'pro' : 'free'
    })
    .eq('stripe_customer_id', customerId);
}

async function handleSubscriptionDeleted(subscription: Stripe.Subscription) {
  const customerId = subscription.customer as string;

  await supabase
    .from('users')
    .update({
      subscription_status: 'cancelled',
      plan: 'free'
    })
    .eq('stripe_customer_id', customerId);
}
```

### Pricing Page

```tsx
// src/app/(marketing)/pricing/page.tsx
'use client';

import { useState } from 'react';
import { Check } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { PLANS } from '@/lib/stripe/plans';

export default function PricingPage() {
  const [loading, setLoading] = useState(false);

  const handleSubscribe = async () => {
    setLoading(true);

    const res = await fetch('/api/create-checkout-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ plan: 'pro' })
    });

    const { url } = await res.json();
    window.location.href = url;
  };

  return (
    <div className="max-w-6xl mx-auto py-24 px-6">
      <div className="text-center mb-16">
        <h1 className="text-5xl font-bold mb-4">Simple, Transparent Pricing</h1>
        <p className="text-xl text-muted-foreground">
          Start free, upgrade when you're ready
        </p>
      </div>

      <div className="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
        {/* Free Plan */}
        <Card className="p-8">
          <h3 className="text-2xl font-bold mb-2">{PLANS.free.name}</h3>
          <div className="mb-6">
            <span className="text-4xl font-bold">$0</span>
            <span className="text-muted-foreground">/month</span>
          </div>

          <Button variant="outline" className="w-full mb-6">
            Current Plan
          </Button>

          <ul className="space-y-3">
            {PLANS.free.features.map((feature) => (
              <li key={feature} className="flex items-start gap-2">
                <Check className="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" />
                <span>{feature}</span>
              </li>
            ))}
          </ul>
        </Card>

        {/* Pro Plan */}
        <Card className="p-8 border-2 border-primary relative">
          <div className="absolute -top-4 left-1/2 -translate-x-1/2 bg-primary text-primary-foreground px-4 py-1 rounded-full text-sm font-medium">
            Most Popular
          </div>

          <h3 className="text-2xl font-bold mb-2">{PLANS.pro.name}</h3>
          <div className="mb-6">
            <span className="text-4xl font-bold">${PLANS.pro.price}</span>
            <span className="text-muted-foreground">/month</span>
          </div>

          <Button className="w-full mb-6" onClick={handleSubscribe} disabled={loading}>
            {loading ? 'Loading...' : 'Upgrade to Pro'}
          </Button>

          <ul className="space-y-3">
            {PLANS.pro.features.map((feature) => (
              <li key={feature} className="flex items-start gap-2">
                <Check className="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" />
                <span>{feature}</span>
              </li>
            ))}
          </ul>
        </Card>
      </div>
    </div>
  );
}
```

### Billing Portal

```typescript
// app/api/create-portal-session/route.ts
export const POST = withAuth(async (req, userId) => {
  const { data: user } = await supabase
    .from('users')
    .select('stripe_customer_id')
    .eq('id', userId)
    .single();

  if (!user?.stripe_customer_id) {
    return NextResponse.json({ error: 'No subscription found' }, { status: 400 });
  }

  const session = await stripe.billingPortal.sessions.create({
    customer: user.stripe_customer_id,
    return_url: `${process.env.NEXT_PUBLIC_URL}/settings`
  });

  return NextResponse.json({ url: session.url });
});
```

---

## Tasks

| Task | Estimate |
|------|----------|
| Set up Stripe account | 30 min |
| Create products/prices | 20 min |
| Implement checkout flow | 90 min |
| Add webhook handler | 60 min |
| Create pricing page | 60 min |
| Add billing portal | 30 min |
| Test subscription flow | 60 min |

---

## Acceptance Criteria
- [ ] Checkout flow works
- [ ] Webhooks handle subscription events
- [ ] Users upgraded to pro on payment
- [ ] Billing portal accessible
- [ ] Failed payments handled
- [ ] Subscription cancellation works
- [ ] Test mode fully functional

---

## Environment Variables

```env
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...
```
