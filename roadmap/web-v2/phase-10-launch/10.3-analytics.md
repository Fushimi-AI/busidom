# Feature 10.3: Analytics & Tracking (Web)

## Metadata
| Field | Value |
|-------|-------|
| **Feature ID** | WEB-10.3 |
| **Phase** | 10 - Launch & Growth (Web) |
| **Priority** | Medium |
| **Estimated Effort** | 2-3 hours |
| **Dependencies** | WEB-8.1 (Next.js Setup) |
| **Approval** | [ ] |
| **Status** | Not Started |

---

## Overview

Analytics integration with Vercel Analytics, PostHog for product analytics, and custom event tracking for user behavior and conversion funnels.

---

## Technical Specification

### Vercel Analytics

```typescript
// src/app/layout.tsx
import { Analytics } from '@vercel/analytics/react';
import { SpeedInsights } from '@vercel/speed-insights/next';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html>
      <body>
        {children}
        <Analytics />
        <SpeedInsights />
      </body>
    </html>
  );
}
```

### PostHog Setup

```typescript
// lib/analytics/posthog.ts
import posthog from 'posthog-js';

if (typeof window !== 'undefined') {
  posthog.init(process.env.NEXT_PUBLIC_POSTHOG_KEY!, {
    api_host: 'https://app.posthog.com',
    loaded: (posthog) => {
      if (process.env.NODE_ENV === 'development') posthog.debug();
    }
  });
}

export { posthog };

// components/PostHogProvider.tsx
'use client';

import { useEffect } from 'react';
import { usePathname, useSearchParams } from 'next/navigation';
import { posthog } from '@/lib/analytics/posthog';

export function PostHogProvider({ children }: { children: React.ReactNode }) {
  const pathname = usePathname();
  const searchParams = useSearchParams();

  useEffect(() => {
    if (pathname) {
      posthog.capture('$pageview', {
        '$current_url': window.location.href
      });
    }
  }, [pathname, searchParams]);

  return <>{children}</>;
}
```

### Custom Event Tracking

```typescript
// lib/analytics/events.ts
import { posthog } from './posthog';

export const analytics = {
  track: (event: string, properties?: Record<string, any>) => {
    if (typeof window === 'undefined') return;

    posthog.capture(event, properties);
  },

  identify: (userId: string, traits?: Record<string, any>) => {
    if (typeof window === 'undefined') return;

    posthog.identify(userId, traits);
  },

  // Conversion events
  signUp: (method: 'email' | 'google') => {
    analytics.track('Sign Up', { method });
  },

  subscribe: (plan: string) => {
    analytics.track('Subscribe', { plan });
  },

  // Engagement events
  sendMessage: (conversationId: string) => {
    analytics.track('Send Message', { conversationId });
  },

  startWorkflow: (workflowId: string) => {
    analytics.track('Start Workflow', { workflowId });
  },

  completeWorkflow: (workflowId: string, duration: number) => {
    analytics.track('Complete Workflow', { workflowId, duration });
  }
};
```

### Usage Tracking

```typescript
// app/api/track-usage/route.ts
export const POST = withAuth(async (req, userId) => {
  const { event, properties } = await req.json();

  // Track in PostHog
  analytics.track(event, { userId, ...properties });

  // Update usage quota if needed
  if (event === 'send_message') {
    await incrementConversationCount(userId);
  }

  return NextResponse.json({ success: true });
});

async function incrementConversationCount(userId: string) {
  const { data: user } = await supabase
    .from('users')
    .select('usage')
    .eq('id', userId)
    .single();

  const currentMonth = new Date().toISOString().slice(0, 7);
  const usage = user.usage || {};

  if (!usage[currentMonth]) {
    usage[currentMonth] = { conversations: 0 };
  }

  usage[currentMonth].conversations += 1;

  await supabase
    .from('users')
    .update({ usage })
    .eq('id', userId);
}
```

---

## Tasks

| Task | Estimate |
|------|----------|
| Set up Vercel Analytics | 15 min |
| Configure PostHog | 30 min |
| Create event tracking | 45 min |
| Add usage tracking | 45 min |
| Test analytics | 30 min |

---

## Acceptance Criteria
- [ ] Vercel Analytics working
- [ ] PostHog tracking events
- [ ] Custom events tracked
- [ ] Usage quotas tracked
- [ ] Conversion funnels visible

---

## Dependencies

```json
{
  "@vercel/analytics": "^1.1.1",
  "@vercel/speed-insights": "^1.0.2",
  "posthog-js": "^1.96.1"
}
```

---

## Key Metrics to Track

- Sign-ups (email vs Google)
- Onboarding completion rate
- Time to first message
- Daily active users (DAU)
- Monthly active users (MAU)
- Conversations per user
- Workflows started/completed
- Subscription conversions
- Churn rate
