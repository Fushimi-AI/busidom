# Feature 8.3: Settings & Preferences (Web)

## Metadata
| Field | Value |
|-------|-------|
| **Feature ID** | WEB-8.3 |
| **Phase** | 8 - Web Application (Web) |
| **Priority** | Medium |
| **Estimated Effort** | 3-4 hours |
| **Dependencies** | WEB-8.1 (Next.js Setup), WEB-7.2 (Auth System) |
| **Approval** | [ ] |
| **Status** | Not Started |

---

## Overview

User settings page for managing profile, API keys, notification preferences, automation schedules, and account settings.

## User Story

As a **web user**, I want **to customize my preferences** so that **the app works exactly how I want it**.

---

## Requirements

### Functional
1. Profile settings (name, email, avatar)
2. API key management (OpenAI, Anthropic, Kimi)
3. Notification preferences (email, push)
4. Automation schedule settings
5. Theme preference (light/dark/system)
6. Timezone selection
7. Account deletion

### Non-Functional
- Secure API key storage (encrypted)
- Form validation
- Auto-save on changes
- Clear success/error feedback

---

## Technical Specification

### Settings Page

```tsx
// src/app/(dashboard)/settings/page.tsx
'use client';

import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { ProfileSettings } from '@/components/settings/profile-settings';
import { APIKeySettings } from '@/components/settings/api-key-settings';
import { NotificationSettings } from '@/components/settings/notification-settings';
import { AutomationSettings } from '@/components/settings/automation-settings';
import { AccountSettings } from '@/components/settings/account-settings';

export default function SettingsPage() {
  return (
    <div className="max-w-4xl mx-auto">
      <h1 className="text-3xl font-bold mb-6">Settings</h1>

      <Tabs defaultValue="profile" className="space-y-6">
        <TabsList>
          <TabsTrigger value="profile">Profile</TabsTrigger>
          <TabsTrigger value="api-keys">API Keys</TabsTrigger>
          <TabsTrigger value="notifications">Notifications</TabsTrigger>
          <TabsTrigger value="automation">Automation</TabsTrigger>
          <TabsTrigger value="account">Account</TabsTrigger>
        </TabsList>

        <TabsContent value="profile">
          <ProfileSettings />
        </TabsContent>

        <TabsContent value="api-keys">
          <APIKeySettings />
        </TabsContent>

        <TabsContent value="notifications">
          <NotificationSettings />
        </TabsContent>

        <TabsContent value="automation">
          <AutomationSettings />
        </TabsContent>

        <TabsContent value="account">
          <AccountSettings />
        </TabsContent>
      </Tabs>
    </div>
  );
}
```

### Profile Settings Component

```tsx
// src/components/settings/profile-settings.tsx
'use client';

import { useState } from 'react';
import { useAuth } from '@/hooks/useAuth';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { useToast } from '@/hooks/useToast';

export function ProfileSettings() {
  const { user } = useAuth();
  const { toast } = useToast();
  const [name, setName] = useState(user?.name || '');
  const [email, setEmail] = useState(user?.email || '');
  const [isSaving, setIsSaving] = useState(false);

  const handleSave = async () => {
    try {
      setIsSaving(true);

      const res = await fetch('/api/user/profile', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email })
      });

      if (!res.ok) throw new Error();

      toast({
        title: 'Success',
        description: 'Profile updated successfully'
      });
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to update profile',
        variant: 'destructive'
      });
    } finally {
      setIsSaving(false);
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Profile</CardTitle>
        <CardDescription>Update your profile information</CardDescription>
      </CardHeader>

      <CardContent className="space-y-6">
        <div className="flex items-center gap-4">
          <Avatar className="w-20 h-20">
            <AvatarImage src={user?.image} />
            <AvatarFallback>{user?.name?.[0]}</AvatarFallback>
          </Avatar>

          <Button variant="outline">Change Avatar</Button>
        </div>

        <div className="space-y-2">
          <Label htmlFor="name">Name</Label>
          <Input
            id="name"
            value={name}
            onChange={(e) => setName(e.target.value)}
          />
        </div>

        <div className="space-y-2">
          <Label htmlFor="email">Email</Label>
          <Input
            id="email"
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
          />
        </div>

        <Button onClick={handleSave} disabled={isSaving}>
          {isSaving ? 'Saving...' : 'Save Changes'}
        </Button>
      </CardContent>
    </Card>
  );
}
```

### API Key Settings

```tsx
// src/components/settings/api-key-settings.tsx
'use client';

import { useState, useEffect } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { Eye, EyeOff, Check, X } from 'lucide-react';
import { useToast } from '@/hooks/useToast';

export function APIKeySettings() {
  const [keys, setKeys] = useState({
    openai: '',
    anthropic: '',
    kimi: ''
  });
  const [showKeys, setShowKeys] = useState({
    openai: false,
    anthropic: false,
    kimi: false
  });
  const [verified, setVerified] = useState({
    openai: false,
    anthropic: false,
    kimi: false
  });
  const { toast } = useToast();

  useEffect(() => {
    fetchAPIKeys();
  }, []);

  const fetchAPIKeys = async () => {
    const res = await fetch('/api/user/api-keys');
    const data = await res.json();

    // Show masked keys
    setKeys({
      openai: data.openai ? maskKey(data.openai) : '',
      anthropic: data.anthropic ? maskKey(data.anthropic) : '',
      kimi: data.kimi ? maskKey(data.kimi) : ''
    });

    setVerified(data.verified);
  };

  const handleSaveKey = async (provider: string, key: string) => {
    try {
      const res = await fetch('/api/user/api-keys', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ provider, key })
      });

      if (!res.ok) throw new Error();

      toast({
        title: 'Success',
        description: `${provider} API key saved and verified`
      });

      fetchAPIKeys();
    } catch (error) {
      toast({
        title: 'Error',
        description: `Invalid ${provider} API key`,
        variant: 'destructive'
      });
    }
  };

  const maskKey = (key: string) => {
    if (!key) return '';
    return `${key.slice(0, 7)}${'*'.repeat(20)}${key.slice(-4)}`;
  };

  return (
    <div className="space-y-4">
      {/* OpenAI */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle>OpenAI API Key</CardTitle>
              <CardDescription>For GPT-4 and embeddings</CardDescription>
            </div>
            {verified.openai ? (
              <Check className="text-green-600" />
            ) : (
              <X className="text-red-600" />
            )}
          </div>
        </CardHeader>

        <CardContent className="space-y-4">
          <div className="space-y-2">
            <Label>API Key</Label>
            <div className="flex gap-2">
              <Input
                type={showKeys.openai ? 'text' : 'password'}
                value={keys.openai}
                onChange={(e) => setKeys({ ...keys, openai: e.target.value })}
                placeholder="sk-..."
              />
              <Button
                variant="outline"
                size="icon"
                onClick={() => setShowKeys({ ...showKeys, openai: !showKeys.openai })}
              >
                {showKeys.openai ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
              </Button>
            </div>
          </div>

          <Button onClick={() => handleSaveKey('openai', keys.openai)}>
            Save & Verify
          </Button>

          <p className="text-sm text-muted-foreground">
            Get your API key from{' '}
            <a href="https://platform.openai.com/api-keys" target="_blank" className="underline">
              OpenAI Platform
            </a>
          </p>
        </CardContent>
      </Card>

      {/* Similar cards for Anthropic and Kimi */}
    </div>
  );
}
```

### Automation Settings

```tsx
// src/components/settings/automation-settings.tsx
'use client';

import { useState, useEffect } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Label } from '@/components/ui/label';
import { Switch } from '@/components/ui/switch';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { useToast } from '@/hooks/useToast';

export function AutomationSettings() {
  const [settings, setSettings] = useState({
    dailyBriefEnabled: true,
    dailyBriefHour: 9,
    weeklyReviewEnabled: true,
    weeklyReviewHour: 18,
    timezone: 'America/New_York'
  });
  const { toast } = useToast();

  useEffect(() => {
    fetchSettings();
  }, []);

  const fetchSettings = async () => {
    const res = await fetch('/api/user/preferences');
    const data = await res.json();
    setSettings(data);
  };

  const updateSetting = async (key: string, value: any) => {
    const updated = { ...settings, [key]: value };
    setSettings(updated);

    try {
      await fetch('/api/user/preferences', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updated)
      });

      toast({
        title: 'Success',
        description: 'Settings updated'
      });
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to update settings',
        variant: 'destructive'
      });
    }
  };

  return (
    <div className="space-y-4">
      <Card>
        <CardHeader>
          <CardTitle>Daily Brief</CardTitle>
          <CardDescription>
            Receive a daily business brief with progress, priorities, and insights
          </CardDescription>
        </CardHeader>

        <CardContent className="space-y-4">
          <div className="flex items-center justify-between">
            <Label>Enable Daily Brief</Label>
            <Switch
              checked={settings.dailyBriefEnabled}
              onCheckedChange={(checked) => updateSetting('dailyBriefEnabled', checked)}
            />
          </div>

          {settings.dailyBriefEnabled && (
            <div className="space-y-2">
              <Label>Send Time</Label>
              <Select
                value={settings.dailyBriefHour.toString()}
                onValueChange={(value) => updateSetting('dailyBriefHour', parseInt(value))}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {Array.from({ length: 24 }, (_, i) => (
                    <SelectItem key={i} value={i.toString()}>
                      {i.toString().padStart(2, '0')}:00
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          )}
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>Weekly Review</CardTitle>
          <CardDescription>
            Get a comprehensive weekly review every Friday
          </CardDescription>
        </CardHeader>

        <CardContent className="space-y-4">
          <div className="flex items-center justify-between">
            <Label>Enable Weekly Review</Label>
            <Switch
              checked={settings.weeklyReviewEnabled}
              onCheckedChange={(checked) => updateSetting('weeklyReviewEnabled', checked)}
            />
          </div>

          {settings.weeklyReviewEnabled && (
            <div className="space-y-2">
              <Label>Send Time (Fridays)</Label>
              <Select
                value={settings.weeklyReviewHour.toString()}
                onValueChange={(value) => updateSetting('weeklyReviewHour', parseInt(value))}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {Array.from({ length: 24 }, (_, i) => (
                    <SelectItem key={i} value={i.toString()}>
                      {i.toString().padStart(2, '0')}:00
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          )}
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>Timezone</CardTitle>
          <CardDescription>Your local timezone for scheduling</CardDescription>
        </CardHeader>

        <CardContent>
          <Select
            value={settings.timezone}
            onValueChange={(value) => updateSetting('timezone', value)}
          >
            <SelectTrigger>
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="America/New_York">Eastern Time</SelectItem>
              <SelectItem value="America/Chicago">Central Time</SelectItem>
              <SelectItem value="America/Denver">Mountain Time</SelectItem>
              <SelectItem value="America/Los_Angeles">Pacific Time</SelectItem>
              <SelectItem value="Europe/London">London</SelectItem>
              <SelectItem value="Europe/Paris">Paris</SelectItem>
              <SelectItem value="Asia/Tokyo">Tokyo</SelectItem>
            </SelectContent>
          </Select>
        </CardContent>
      </Card>
    </div>
  );
}
```

---

## Tasks

| Task | Estimate |
|------|----------|
| Create settings page layout | 30 min |
| Build profile settings | 45 min |
| Build API key settings | 60 min |
| Build notification settings | 30 min |
| Build automation settings | 45 min |
| Add account deletion | 20 min |
| Write tests | 30 min |

---

## Acceptance Criteria
- [ ] Profile updates work
- [ ] API keys securely stored
- [ ] Automation preferences save
- [ ] Timezone selection works
- [ ] Theme toggle works
- [ ] Form validation
- [ ] Auto-save on changes

---

## Dependencies

Already included in WEB-8.1 shadcn/ui setup
