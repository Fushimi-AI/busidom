# Feature 9.3: Push Notifications (Mobile)

## Metadata
| Field | Value |
|-------|-------|
| **Feature ID** | WEB-9.3 |
| **Phase** | 9 - Mobile Application (Mobile) |
| **Priority** | High |
| **Estimated Effort** | 3-4 hours |
| **Dependencies** | WEB-9.1 (RN Setup), WEB-7.5 (Cloud Scheduler) |
| **Approval** | [ ] |
| **Status** | Not Started |

---

## Overview

Push notification system for daily briefs, weekly reviews, new AI responses, and workflow updates using Expo Notifications.

---

## Technical Specification

### Push Notification Setup

```typescript
// src/services/notifications.ts
import * as Notifications from 'expo-notifications';
import * as Device from 'expo-device';
import { Platform } from 'react-native';
import api from './api';

// Configure notification behavior
Notifications.setNotificationHandler({
  handleNotification: async () => ({
    shouldShowAlert: true,
    shouldPlaySound: true,
    shouldSetBadge: true
  })
});

export async function registerForPushNotifications(): Promise<string | null> {
  if (!Device.isDevice) {
    console.log('Must use physical device for push notifications');
    return null;
  }

  const { status: existingStatus } = await Notifications.getPermissionsAsync();
  let finalStatus = existingStatus;

  if (existingStatus !== 'granted') {
    const { status } = await Notifications.requestPermissionsAsync();
    finalStatus = status;
  }

  if (finalStatus !== 'granted') {
    alert('Failed to get push token for notifications');
    return null;
  }

  const token = (await Notifications.getExpoPushTokenAsync()).data;

  // Send token to backend
  await api.post('/user/push-token', { token });

  // Configure Android
  if (Platform.OS === 'android') {
    Notifications.setNotificationChannelAsync('default', {
      name: 'default',
      importance: Notifications.AndroidImportance.MAX,
      vibrationPattern: [0, 250, 250, 250],
      lightColor: '#3b82f6'
    });
  }

  return token;
}

export function setupNotificationListeners() {
  // Handle notification received while app is foregrounded
  const notificationListener = Notifications.addNotificationReceivedListener((notification) => {
    console.log('Notification received:', notification);
  });

  // Handle user tapping notification
  const responseListener = Notifications.addNotificationResponseReceivedListener((response) => {
    const data = response.notification.request.content.data;

    // Navigate based on notification type
    if (data.type === 'new_message') {
      // Navigate to chat
    } else if (data.type === 'daily_brief') {
      // Navigate to brief
    } else if (data.type === 'workflow_update') {
      // Navigate to workflow
    }
  });

  return () => {
    Notifications.removeNotificationSubscription(notificationListener);
    Notifications.removeNotificationSubscription(responseListener);
  };
}

export async function scheduleDailyBrief(hour: number) {
  await Notifications.cancelAllScheduledNotificationsAsync();

  await Notifications.scheduleNotificationAsync({
    content: {
      title: 'Daily Business Brief',
      body: 'Your daily brief is ready',
      data: { type: 'daily_brief' }
    },
    trigger: {
      hour,
      minute: 0,
      repeats: true
    }
  });
}
```

### Notification Preferences Screen

```tsx
// src/screens/settings/NotificationsScreen.tsx
import React, { useState, useEffect } from 'react';
import { View, Text, StyleSheet, Switch, ScrollView } from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useTheme } from '../../theme/ThemeProvider';
import api from '../../services/api';

export function NotificationsScreen() {
  const { theme } = useTheme();
  const [settings, setSettings] = useState({
    dailyBrief: true,
    weeklyReview: true,
    newMessages: true,
    workflowUpdates: true
  });

  useEffect(() => {
    fetchSettings();
  }, []);

  const fetchSettings = async () => {
    const res = await api.get('/user/notification-settings');
    setSettings(res.data);
  };

  const updateSetting = async (key: string, value: boolean) => {
    setSettings({ ...settings, [key]: value });

    await api.patch('/user/notification-settings', {
      [key]: value
    });
  };

  return (
    <SafeAreaView style={[styles.container, { backgroundColor: theme.colors.background }]}>
      <ScrollView>
        <View style={styles.section}>
          <Text style={[styles.sectionTitle, { color: theme.colors.text }]}>
            Scheduled Notifications
          </Text>

          <View style={[styles.item, { backgroundColor: theme.colors.card }]}>
            <Text style={[styles.itemLabel, { color: theme.colors.text }]}>
              Daily Brief
            </Text>
            <Switch
              value={settings.dailyBrief}
              onValueChange={(value) => updateSetting('dailyBrief', value)}
            />
          </View>

          <View style={[styles.item, { backgroundColor: theme.colors.card }]}>
            <Text style={[styles.itemLabel, { color: theme.colors.text }]}>
              Weekly Review
            </Text>
            <Switch
              value={settings.weeklyReview}
              onValueChange={(value) => updateSetting('weeklyReview', value)}
            />
          </View>
        </View>

        <View style={styles.section}>
          <Text style={[styles.sectionTitle, { color: theme.colors.text }]}>
            Activity Notifications
          </Text>

          <View style={[styles.item, { backgroundColor: theme.colors.card }]}>
            <Text style={[styles.itemLabel, { color: theme.colors.text }]}>
              New AI Responses
            </Text>
            <Switch
              value={settings.newMessages}
              onValueChange={(value) => updateSetting('newMessages', value)}
            />
          </View>

          <View style={[styles.item, { backgroundColor: theme.colors.card }]}>
            <Text style={[styles.itemLabel, { color: theme.colors.text }]}>
              Workflow Updates
            </Text>
            <Switch
              value={settings.workflowUpdates}
              onValueChange={(value) => updateSetting('workflowUpdates', value)}
            />
          </View>
        </View>
      </ScrollView>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1 },
  section: { marginTop: 24, paddingHorizontal: 16 },
  sectionTitle: { fontSize: 18, fontWeight: '600', marginBottom: 12 },
  item: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 16,
    borderRadius: 8,
    marginBottom: 8
  },
  itemLabel: { fontSize: 16 }
});
```

---

## Tasks

| Task | Estimate |
|------|----------|
| Set up Expo Notifications | 45 min |
| Implement token registration | 30 min |
| Add notification listeners | 45 min |
| Create notification settings screen | 45 min |
| Test notifications (iOS/Android) | 60 min |

---

## Acceptance Criteria
- [ ] Push notifications work on iOS/Android
- [ ] Daily brief notifications
- [ ] New message notifications
- [ ] Workflow update notifications
- [ ] User can manage preferences
- [ ] Tapping notification navigates correctly

---

## Dependencies

```json
{
  "expo-notifications": "~0.27.0",
  "expo-device": "~5.9.0"
}
```
