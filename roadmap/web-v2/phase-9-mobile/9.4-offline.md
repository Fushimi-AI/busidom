# Feature 9.4: Offline Support (Mobile)

## Metadata
| Field | Value |
|-------|-------|
| **Feature ID** | WEB-9.4 |
| **Phase** | 9 - Mobile Application (Mobile) |
| **Priority** | Medium |
| **Estimated Effort** | 3-4 hours |
| **Dependencies** | WEB-9.2 (Mobile Chat) |
| **Approval** | [ ] |
| **Status** | Not Started |

---

## Overview

Offline-first architecture with local data persistence, sync queue, and seamless online/offline transitions.

---

## Technical Specification

### Offline Store

```typescript
// src/store/offlineStore.ts
import { create } from 'zustand';
import AsyncStorage from '@react-native-async-storage/async-storage';
import NetInfo from '@react-native-community/netinfo';

interface OfflineState {
  isOnline: boolean;
  syncQueue: SyncAction[];
  addToSyncQueue: (action: SyncAction) => void;
  processSyncQueue: () => Promise<void>;
  initializeOfflineSupport: () => void;
}

export const useOfflineStore = create<OfflineState>((set, get) => ({
  isOnline: true,
  syncQueue: [],

  initializeOfflineSupport: () => {
    // Monitor network status
    NetInfo.addEventListener(state => {
      const wasOffline = !get().isOnline;
      const isNowOnline = state.isConnected ?? false;

      set({ isOnline: isNowOnline });

      // Process queue when coming back online
      if (wasOffline && isNowOnline) {
        get().processSyncQueue();
      }
    });

    // Load sync queue from storage
    AsyncStorage.getItem('sync_queue').then(data => {
      if (data) {
        set({ syncQueue: JSON.parse(data) });
      }
    });
  },

  addToSyncQueue: async (action: SyncAction) => {
    const queue = [...get().syncQueue, action];
    set({ syncQueue: queue });

    // Persist to AsyncStorage
    await AsyncStorage.setItem('sync_queue', JSON.stringify(queue));

    // Try to process if online
    if (get().isOnline) {
      await get().processSyncQueue();
    }
  },

  processSyncQueue: async () => {
    const queue = get().syncQueue;

    if (queue.length === 0 || !get().isOnline) return;

    for (const action of queue) {
      try {
        await executeAction(action);

        // Remove from queue on success
        const newQueue = get().syncQueue.filter(a => a.id !== action.id);
        set({ syncQueue: newQueue });
        await AsyncStorage.setItem('sync_queue', JSON.stringify(newQueue));
      } catch (error) {
        console.error('Sync action failed:', error);
        break; // Stop processing on first error
      }
    }
  }
}));

async function executeAction(action: SyncAction) {
  switch (action.type) {
    case 'send_message':
      await api.post(`/conversations/${action.data.conversationId}/messages`, action.data);
      break;

    case 'update_business':
      await api.patch(`/businesses/${action.data.id}`, action.data);
      break;

    // ... other actions
  }
}
```

### Offline Indicator

```tsx
// src/components/OfflineIndicator.tsx
import React from 'react';
import { View, Text, StyleSheet } from 'react-native';
import { WifiOff } from 'lucide-react-native';
import { useOfflineStore } from '../store/offlineStore';

export function OfflineIndicator() {
  const { isOnline } = useOfflineStore();

  if (isOnline) return null;

  return (
    <View style={styles.container}>
      <WifiOff color="#ffffff" size={16} />
      <Text style={styles.text}>Offline - Changes will sync when connected</Text>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    backgroundColor: '#f59e0b',
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    padding: 8,
    gap: 8
  },
  text: {
    color: '#ffffff',
    fontSize: 14,
    fontWeight: '500'
  }
});
```

---

## Tasks

| Task | Estimate |
|------|----------|
| Set up offline store | 60 min |
| Implement sync queue | 45 min |
| Add network monitoring | 30 min |
| Create offline indicator | 20 min |
| Test offline scenarios | 45 min |

---

## Acceptance Criteria
- [ ] Messages queued when offline
- [ ] Sync automatically when online
- [ ] Offline indicator shown
- [ ] No data loss when offline
- [ ] Smooth online/offline transitions

---

## Dependencies

```json
{
  "@react-native-async-storage/async-storage": "^1.21.0",
  "@react-native-community/netinfo": "^11.2.0"
}
```
