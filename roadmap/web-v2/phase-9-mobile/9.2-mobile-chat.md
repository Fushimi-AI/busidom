# Feature 9.2: Mobile Chat Interface (Mobile)

## Metadata
| Field | Value |
|-------|-------|
| **Feature ID** | WEB-9.2 |
| **Phase** | 9 - Mobile Application (Mobile) |
| **Priority** | Critical |
| **Estimated Effort** | 5-6 hours |
| **Dependencies** | WEB-9.1 (RN Setup), WEB-7.4 (API Layer) |
| **Approval** | [ ] |
| **Status** | Not Started |

---

## Overview

Native mobile chat interface with real-time messaging, optimized keyboard handling, message bubbles, markdown rendering, and offline support.

## User Story

As a **mobile user**, I want **a smooth native chat experience** so that **I can have conversations with my AI mentor on the go**.

---

## Technical Specification

### Chat Screen

```tsx
// src/screens/chat/ChatScreen.tsx
import React, { useState, useEffect, useRef } from 'react';
import {
  View,
  FlatList,
  KeyboardAvoidingView,
  Platform,
  StyleSheet
} from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { MessageBubble } from '../../components/chat/MessageBubble';
import { MessageInput } from '../../components/chat/MessageInput';
import { ConversationHeader } from '../../components/chat/ConversationHeader';
import { useChatStore } from '../../store/chatStore';
import { useTheme } from '../../theme/ThemeProvider';

export function ChatScreen() {
  const { theme } = useTheme();
  const { messages, currentConversation, sendMessage } = useChatStore();
  const flatListRef = useRef<FlatList>(null);

  // Auto-scroll to bottom on new messages
  useEffect(() => {
    flatListRef.current?.scrollToEnd({ animated: true });
  }, [messages]);

  const handleSend = async (text: string) => {
    await sendMessage(currentConversation.id, text);
  };

  return (
    <SafeAreaView style={[styles.container, { backgroundColor: theme.colors.background }]}>
      <ConversationHeader conversation={currentConversation} />

      <KeyboardAvoidingView
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
        style={styles.flex}
        keyboardVerticalOffset={90}
      >
        <FlatList
          ref={flatListRef}
          data={messages}
          keyExtractor={(item) => item.id}
          renderItem={({ item }) => <MessageBubble message={item} />}
          contentContainerStyle={styles.messageList}
          onContentSizeChange={() => flatListRef.current?.scrollToEnd()}
        />

        <MessageInput onSend={handleSend} />
      </KeyboardAvoidingView>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1 },
  flex: { flex: 1 },
  messageList: { padding: 16 }
});
```

### Message Bubble

```tsx
// src/components/chat/MessageBubble.tsx
import React from 'react';
import { View, Text, StyleSheet, TouchableOpacity } from 'react-native';
import Markdown from 'react-native-markdown-display';
import { Copy } from 'lucide-react-native';
import * as Clipboard from 'expo-clipboard';
import { useTheme } from '../../theme/ThemeProvider';
import { Message } from '../../types';

interface MessageBubbleProps {
  message: Message;
}

export function MessageBubble({ message }: MessageBubbleProps) {
  const { theme } = useTheme();
  const isUser = message.role === 'user';

  const handleCopy = async () => {
    await Clipboard.setStringAsync(message.content);
  };

  return (
    <View style={[styles.container, isUser && styles.userContainer]}>
      <View
        style={[
          styles.bubble,
          {
            backgroundColor: isUser ? theme.colors.primary : theme.colors.card,
            borderColor: theme.colors.border
          }
        ]}
      >
        <Markdown
          style={{
            body: {
              color: isUser ? '#ffffff' : theme.colors.text,
              fontSize: 15
            },
            code_inline: {
              backgroundColor: isUser ? 'rgba(255,255,255,0.2)' : theme.colors.background,
              paddingHorizontal: 4,
              paddingVertical: 2,
              borderRadius: 3
            }
          }}
        >
          {message.content}
        </Markdown>

        <TouchableOpacity style={styles.copyButton} onPress={handleCopy}>
          <Copy color={isUser ? '#ffffff' : theme.colors.text} size={16} />
        </TouchableOpacity>
      </View>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    marginBottom: 12,
    alignItems: 'flex-start'
  },
  userContainer: {
    alignItems: 'flex-end'
  },
  bubble: {
    maxWidth: '80%',
    padding: 12,
    borderRadius: 16,
    borderWidth: 1,
    position: 'relative'
  },
  copyButton: {
    position: 'absolute',
    top: 8,
    right: 8,
    opacity: 0.6
  }
});
```

### Message Input

```tsx
// src/components/chat/MessageInput.tsx
import React, { useState } from 'react';
import {
  View,
  TextInput,
  TouchableOpacity,
  StyleSheet,
  ActivityIndicator
} from 'react-native';
import { Send } from 'lucide-react-native';
import { useTheme } from '../../theme/ThemeProvider';

interface MessageInputProps {
  onSend: (text: string) => Promise<void>;
}

export function MessageInput({ onSend }: MessageInputProps) {
  const { theme } = useTheme();
  const [text, setText] = useState('');
  const [sending, setSending] = useState(false);

  const handleSend = async () => {
    if (!text.trim() || sending) return;

    setSending(true);
    try {
      await onSend(text);
      setText('');
    } finally {
      setSending(false);
    }
  };

  return (
    <View style={[styles.container, { backgroundColor: theme.colors.card, borderColor: theme.colors.border }]}>
      <TextInput
        style={[styles.input, { color: theme.colors.text }]}
        placeholder="Type a message..."
        placeholderTextColor={theme.colors.textSecondary}
        value={text}
        onChangeText={setText}
        multiline
        maxLength={2000}
        editable={!sending}
      />

      <TouchableOpacity
        style={[
          styles.sendButton,
          { backgroundColor: theme.colors.primary },
          (!text.trim() || sending) && styles.sendButtonDisabled
        ]}
        onPress={handleSend}
        disabled={!text.trim() || sending}
      >
        {sending ? (
          <ActivityIndicator color="#ffffff" />
        ) : (
          <Send color="#ffffff" size={20} />
        )}
      </TouchableOpacity>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flexDirection: 'row',
    padding: 12,
    borderTopWidth: 1,
    alignItems: 'flex-end'
  },
  input: {
    flex: 1,
    maxHeight: 100,
    paddingHorizontal: 12,
    paddingVertical: 8,
    fontSize: 16
  },
  sendButton: {
    width: 40,
    height: 40,
    borderRadius: 20,
    justifyContent: 'center',
    alignItems: 'center',
    marginLeft: 8
  },
  sendButtonDisabled: {
    opacity: 0.5
  }
});
```

### Chat Store

```typescript
// src/store/chatStore.ts
import { create } from 'zustand';
import api from '../services/api';
import { Message, Conversation } from '../types';

interface ChatState {
  conversations: Conversation[];
  currentConversation: Conversation | null;
  messages: Message[];
  isLoading: boolean;
  fetchConversations: (businessId: string) => Promise<void>;
  selectConversation: (id: string) => Promise<void>;
  sendMessage: (conversationId: string, content: string) => Promise<void>;
}

export const useChatStore = create<ChatState>((set, get) => ({
  conversations: [],
  currentConversation: null,
  messages: [],
  isLoading: false,

  fetchConversations: async (businessId: string) => {
    set({ isLoading: true });

    try {
      const res = await api.get(`/conversations?businessId=${businessId}`);
      set({ conversations: res.data.data, isLoading: false });
    } catch (error) {
      set({ isLoading: false });
      throw error;
    }
  },

  selectConversation: async (id: string) => {
    const conversation = get().conversations.find(c => c.id === id);
    if (!conversation) return;

    set({ currentConversation: conversation, isLoading: true });

    try {
      const res = await api.get(`/conversations/${id}/messages`);
      set({ messages: res.data.data, isLoading: false });
    } catch (error) {
      set({ isLoading: false });
      throw error;
    }
  },

  sendMessage: async (conversationId: string, content: string) => {
    // Optimistic update
    const tempMessage: Message = {
      id: `temp-${Date.now()}`,
      conversation_id: conversationId,
      role: 'user',
      content,
      created_at: Date.now()
    };

    set({ messages: [...get().messages, tempMessage] });

    try {
      const res = await api.post(`/conversations/${conversationId}/messages`, {
        role: 'user',
        content
      });

      // Replace temp message with real one
      set({
        messages: get().messages.map(m =>
          m.id === tempMessage.id ? res.data : m
        )
      });
    } catch (error) {
      // Remove temp message on error
      set({
        messages: get().messages.filter(m => m.id !== tempMessage.id)
      });
      throw error;
    }
  }
}));
```

---

## Tasks

| Task | Estimate |
|------|----------|
| Create chat screen | 60 min |
| Build message bubble | 45 min |
| Build message input | 45 min |
| Add markdown rendering | 30 min |
| Implement chat store | 60 min |
| Add keyboard handling | 30 min |
| Optimize performance | 30 min |

---

## Acceptance Criteria
- [ ] Messages display correctly
- [ ] Markdown renders
- [ ] Keyboard handling smooth
- [ ] Auto-scroll to bottom
- [ ] Optimistic updates work
- [ ] Offline queueing
- [ ] 60fps scrolling

---

## Dependencies

```json
{
  "react-native-markdown-display": "^7.0.2",
  "expo-clipboard": "~5.0.0"
}
```
